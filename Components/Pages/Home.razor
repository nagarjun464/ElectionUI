@* @page "/home" *@
@* @using System.Security.Claims *@
@* @using Microsoft.AspNetCore.Components.Authorization *@
@* @inject AuthenticationStateProvider AuthStateProvider *@

@* <h3>Welcome Home!</h3> *@

@* @if (authUser != null) *@
@* { *@
@*     <p>Hello, <b>@authUser.Identity.Name</b> 👋</p> *@
@*     <p>Email: @email</p> *@
@*     <button class="btn btn-danger" @onclick="Logout">Logout</button> *@
@* } *@
@* else *@
@* { *@
@*     <p>Loading user info...</p> *@
@* } *@

@* @code { *@
@*     private ClaimsPrincipal? authUser; *@
@*     private string? email; *@

@*     protected override async Task OnInitializedAsync() *@
@*     { *@
@*         var state = await AuthStateProvider.GetAuthenticationStateAsync(); *@
@*         authUser = state.User; *@

@*         if (authUser.Identity != null && authUser.Identity.IsAuthenticated) *@
@*         { *@
@*             email = authUser.FindFirst(c => c.Type.Contains("emailaddress"))?.Value; *@
@*         } *@
@*         else *@
@*         { *@
@*             email = "Guest"; *@
@*         } *@
@*     } *@

@*     private void Logout() *@
@*     { *@
@*         ((CustomAuthStateProvider)AuthStateProvider).MarkUserAsLoggedOut(); *@
@*     } *@
@* } *@



@* @page "/home" *@
@*  @attribute [Authorize]  *@
@*  @using Microsoft.AspNetCore.Components.Authorization  *@
@*  @using Microsoft.AspNetCore.Authorization  *@
@*  @using Blazored.Toast.Services  *@
@*  @rendermode InteractiveServer  *@
@*  @using Electionapp.UI.Models;  *@
@*  @inject NavigationManager Nav  *@
@*  @inject IJSRuntime JS  *@

@*  <div class="home-page">  *@
@*  @if (!string.IsNullOrEmpty(successMessage))  *@
@*  {  *@
@*      <div class="alert alert-success text-center mt-3" role="alert">  *@
@*          @successMessage  *@
@*      </div>  *@
@*  }  *@
@*  <div class="hero">  *@
@*      <div class="overlay">  *@
@*          <h1>Welcome to Election Admin</h1>  *@
@*          <p>Manage elections, candidates, and more.</p>  *@
@*      </div>  *@
@*  </div>  *@
@*  </div>  *@
@*  @code {  *@
@*      private string? successMessage;  *@

@*      protected override void OnInitialized()  *@
@*      {  *@
@*          var uri = new Uri(Nav.Uri);  *@
@*          var query = Microsoft.AspNetCore.WebUtilities.QueryHelpers.ParseQuery(uri.Query);  *@

@*          string email = query.TryGetValue("email", out var mail) ? mail.ToString() : string.Empty;  *@
@*          string User = query.TryGetValue("user", out var user) ? user.ToString() : string.Empty;  *@

@*          if (!string.IsNullOrEmpty(email) && email.Contains("@"))  *@
@*          {  *@
@*              var username = email.Split('@')[0];   *@
@*              successMessage = $"👋 Hey {username}, login successful!";  *@
@*          }  *@
@*          else if (!string.IsNullOrEmpty(User))  *@
@*          {  *@
@*              if (User.Contains("@"))  *@
@*              {  *@
@*                  var username = User.Split('@')[0];  *@
@*                  successMessage = $"👋 Hey {username}, login successful!";  *@
@*              }  *@
@*              else{  *@
@*  				var username = User;  *@
@*                  successMessage = $"👋 Hey {username}, login successful!";  *@
@*              }  *@
@*          }  *@
@*          else  *@
@*          {  *@
@*              successMessage = "✅ Login was successful!";  *@
@*          }  *@
       
@*      }  *@
@*      protected override async Task OnAfterRenderAsync(bool firstRender)  *@
@*      {  *@
@*          if (firstRender && !string.IsNullOrEmpty(successMessage))  *@
@*          {  *@
@*              await Task.Delay(3000);   *@
@*              successMessage = null;   *@
@*              StateHasChanged();        *@
@*          }  *@
@*      }  *@
@*  }  *@
@*  <style>  *@

@*      html, body {  *@
@*          margin: 0;  *@
@*          padding: 0;  *@
@*          height: 100%;  *@
@*          overflow: hidden;   *@
@*      }  *@
@*      .home-page {  *@
@*          height: 100vh;  *@
@*          width: 100vw;  *@
@*          overflow: hidden;   *@
@*          position: relative;  *@
@*      }  *@
@*      .hero {  *@
@*          position: relative;  *@
@*          height: 100vh;                *@
@*          width: 100%;  *@
@*          background: url('/images/vote-bg.jpg') no-repeat center center;  *@
@*          background-size: cover;       *@
@*          overflow: hidden;             *@
@*          margin: 0;  *@
@*          padding: 0;  *@
@*      }  *@

@*      .overlay {  *@
@*          position: absolute;  *@
@*          top: 50%;  *@
@*          left: 50%;  *@
@*          transform: translate(-50%, -50%);  *@
@*          background: rgba(0, 0, 0, 0.4);   *@
@*          padding: 30px 50px;  *@
@*          border-radius: 10px;  *@
@*          color: white;  *@
@*      }  *@

@*  </style>  *@


@page "/home"
@attribute [Authorize]
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.WebUtilities
@using System.Security.Claims
@inject AuthenticationStateProvider AuthStateProvider
@inject Blazored.LocalStorage.ILocalStorageService localStorage
@inject NavigationManager Nav

@rendermode InteractiveServer

<div class="home-page">
    <AuthorizeView>
        <Authorized>
            <div class="hero">
                <div class="overlay">
                    <h1>Welcome to Election Admin</h1>
                    <p>Email: @email</p>
                    <button class="btn btn-danger" @onclick="Logout">Logout</button>
                </div>
            </div>
        </Authorized>

        <NotAuthorized>
            <p class="text-center mt-3">Redirecting to login...</p>
        </NotAuthorized>
    </AuthorizeView>
</div>

@code {
    private string? email;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var uri = Nav.ToAbsoluteUri(Nav.Uri);

            // ✅ Step 1: Handle token if coming from Google
            if (QueryHelpers.ParseQuery(uri.Query).TryGetValue("token", out var token))
            {
                var jwtToken = token.ToString();

                if (!string.IsNullOrWhiteSpace(jwtToken))
                {
                    // Store token locally
                    await localStorage.SetItemAsync("authToken", jwtToken);

                    // Update authentication state
                    await ((CustomAuthStateProvider)AuthStateProvider).MarkUserAsAuthenticated(jwtToken);

                    // ✅ Remove token from URL after saving
                    Nav.NavigateTo("/", forceLoad: true);
                    return;
                }
                else
                {
                    Console.WriteLine("JWT token missing or invalid in query.");
                }
            }

            // ✅ Step 2: Get user info (after token storage)
            var authState = await AuthStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user.Identity != null && user.Identity.IsAuthenticated)
            {
                email = user.FindFirstValue(ClaimTypes.Email);
                StateHasChanged();
            }
            else
            {
                Nav.NavigateTo("/login", forceLoad: true);
            }
        }
    }

    private async void Logout()
    {
        await ((CustomAuthStateProvider)AuthStateProvider).MarkUserAsLoggedOut();
        Nav.NavigateTo("/login", forceLoad: true);
    }
}

<style>
    .home-page {
        height: 100vh;
        width: 100vw;
        overflow: hidden;
        position: relative;
    }

    .hero {
        position: relative;
        height: 100vh;
        width: 100%;
        background: url('/images/vote-bg.jpg') no-repeat center center;
        background-size: cover;
        overflow: hidden;
        margin: 0;
        padding: 0;
    }

    .overlay {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.4);
        padding: 30px 50px;
        border-radius: 10px;
        color: white;
    }
</style>